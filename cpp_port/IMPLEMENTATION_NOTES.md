# C++ Port Implementation Notes

## Overview

This C++ port of the BinPackage library provides a high-performance runtime for accessing the Database of Icelandic Morphology (BÍN). The implementation focuses on the core lookup functionality while maintaining compatibility with the data files generated by the Python version.

## Architecture

### Key Design Decisions

1. **Memory-mapped I/O** - The compressed dictionary (~82MB) is memory-mapped for efficient access and sharing between processes
2. **Header-only public API** - Clean separation between public interface (`islenska.h`) and implementation details
3. **Reuse existing C++ code** - The original `bin.cpp` trie implementation is reused for word lookups
4. **Platform abstraction** - Memory mapping is abstracted to support Windows, macOS, and Linux

### Module Structure

- `islenska.h` - Public API header
- `islenska_impl.h` - Internal implementation header
- `islenska.cpp` - Main implementation and public interface
- `dawg.cpp` - DAWG dictionary for compound word analysis
- `lookup.cpp` - Word lookup implementations
- `variants.cpp` - Grammatical variant transformations
- `bin.cpp` - Original trie-based lookup (from Python package)

## Key Components

### 1. Data Structures

**BinEntry** - Basic word entry with 6 fields:
- `ord` (lemma), `bin_id`, `ofl` (category), `hluti` (domain), `bmynd` (form), `mark` (tag)

**Ksnid** - Extended entry with 9 additional fields:
- Correctness grades, register indicators, cross-references, etc.

### 2. Binary Format Reader

The implementation reads the compressed binary format created by `binpack.py`:
- Header with section offsets
- Trie structure for word → meaning mappings
- Compressed strings using 7-bit alphabet
- Separate sections for lemmas, meanings, categories, etc.

### 3. Compound Word Analysis

- Uses pre-built DAWG files for prefix/suffix matching
- Finds optimal splits (fewest components, longest suffix)
- Returns compound entries with hyphenated lemmas

### 4. Lookup Methods

- `lookup()` - Basic word form lookup
- `lookup_ksnid()` - Extended data lookup
- `lookup_id()` - Lookup by BÍN ID
- `lookup_cats()` - Get word categories
- `lookup_lemmas_and_cats()` - Get lemmas with categories
- `lookup_variants()` - Grammatical transformations

### 5. Caching

- LRU cache for word lookups (1000 entries)
- Compound word cache (500 entries)
- Thread-safe implementation using mutexes

## Performance Optimizations

1. **Direct memory access** - No parsing or deserialization needed
2. **Binary search in trie** - O(log n) child node lookups
3. **Compressed strings** - 7-bit encoding saves memory
4. **Result caching** - Avoids repeated lookups
5. **Minimal allocations** - Uses move semantics where possible

## Limitations and Future Work

### Current Limitations

1. **Fixed data paths** - Currently expects data in `src/islenska/resources/`
2. **No configuration parsing** - Uses pre-built binary data only
3. **Limited error handling** - Basic file loading errors only
4. **No data generation** - Requires Python tools to build data files

### Potential Improvements

1. **Configurable paths** - Allow custom data file locations
2. **Memory-mapped string pool** - Further reduce allocations
3. **Parallel lookups** - Multi-threaded compound analysis
4. **Index generation** - Build lemma → forms index for faster variants
5. **C API wrapper** - For use from other languages

## Testing

Two test programs demonstrate the functionality:

1. `test_lookup` - Basic word lookups, compounds, categories
2. `test_variants` - Grammatical transformations, case/number changes

## Building and Integration

The library uses CMake for cross-platform builds:

```bash
mkdir build && cd build
cmake -DCMAKE_BUILD_TYPE=Release ..
make
```

Integration in other CMake projects:
```cmake
find_package(islenska REQUIRED)
target_link_libraries(your_app islenska::islenska)
```

## Data Compatibility

The C++ library reads the same binary files as the Python version:
- `compressed.bin` - Main dictionary (82MB)
- `ordalisti-prefixes.dawg.bin` - Valid prefixes
- `ordalisti-suffixes.dawg.bin` - Valid suffixes

No changes to the data format were needed, ensuring full compatibility.